#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


#
# The script start two instances of InfluxDB. The first is unsecured and is reachable on http://localhost:8086.
# The second is secured by HTTPS and is reachable on https://localhost:9086
#

language: java

jdk:
  - oraclejdk8
  - oraclejdk11

sudo: required

cache:
  timeout: 10000
  directories:
    - $HOME/.m2

services:
  - docker

install: true

script:
  - ./scripts/influxdb-restart.sh
  - mvn -B clean verify failsafe:integration-test failsafe:verify
  - bash <(curl -s https://codecov.io/bash)

jobs:
  include:
    - stage: end-to-end
      jdk: oraclejdk8
      script:
        - ./scripts/nifi-restart.sh
        - sleep 30
        - ./scripts/end-to-end.sh
    - stage: deploy
      if: branch = master AND repo = bonitoo-io/nifi-influxdb-bundle AND type IN (push)
      jdk: oraclejdk8
      script: skip
      deploy:
        provider: script
        script: ./scripts/deploy.sh
        skip_cleanup: true

after_failure:
  - cat target/surefire-reports/*.txt